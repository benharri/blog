<!DOCTYPE html>
<html lang="en-us">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" type="text/css" href="gruvbox.css">
        <link rel="stylesheet" type="text/css" href="_pagefind/pagefind-ui.css">
        <link rel="stylesheet" type="text/css" href="blog.css">
        <script type="text/javascript" src="_pagefind/pagefind-ui.js"></script>
        <script>
            window.addEventListener('DOMContentLoaded', (event) => { new PagefindUI({ element: "#search" }); });
        </script>
        <title>raid nonsense</title>
    </head>

    <body>
        <main>
            <div id="search"></div>
    <h1><a href="./raid-nonsense.html">raid nonsense</a></h1>

    <time>Sun, 13 Jan 2019 13:28 UTC</time>
    <p>tags:</p>
     
<ul>
     <li>
        <a href="tags/tilde.html">tilde</a>
    </li> <li>
        <a href="tags/sysadmin.html">sysadmin</a>
    </li></ul>



    <hr>

    <div data-pagefind-body>
    <p>last week i did some
<a href="https://tilde.team/news/025_raid_reboot">maintenance</a> on the
tilde.team box. probably should have written about it sooner but i
didn&rsquo;t make time for it until now.</p>
<!-- raw HTML omitted -->
<p>the gist of the problem was that the default images provided by
<a href="https://hetzner.com">hetzner</a> default to raid1 between the available
disks. our box has two 240gb SSDs, which resulted in 200gb usable space
for /. it also defaulted to giving us a huge swap partition which i deem
unnecessary for a box with 64gb ram.</p>
<p>the only feasible solution that i&rsquo;ve found involved using the rescue
system and the
<a href="https://wiki.hetzner.de/index.php/Installimage/en">installimage</a>
software to reconfigure the disk partitions.</p>
<p><a href="https://yourtilde.com/~deepend/">deepend</a> recently upgraded to a
beefier dedi (more threads and more disk space) and had a bit of
contract time on the old one. he offered to let me use it as a staging
box for the meantime while i reinstalled and reconfigured my raid
settings.</p>
<p>i&rsquo;ve migrated tilde.team twice before (from linode -&gt; woothosting
-&gt; hetzner -&gt; and now back to hetzner on the same box) using a
slick little rsync that i&rsquo;ve put together.</p>
<pre><code>rsync -auHxv --numeric-ids \
    --exclude=/etc/fstab \
    --exclude=/etc/network/* \
    --exclude=/proc/* \
    --exclude=/tmp/* \
    --exclude=/sys/* \
    --exclude=/dev/* \
    --exclude=/mnt/* \
    --exclude=/boot/* \
    --exclude=/root/* \
    root@oldbox:/* /
</code></pre><p>as long as the destination and source boxen are running the same
distro/version, you should be good to go after rebooting the destination
box!</p>
<p>the only thing to watch out for is running databases. it happened to me
this time with mysql. there were 3 pending transactions that were left
open during the rsync backup. it kept failing to start after i got the
box back up, along with all the other services that depend on it.</p>
<p>eventually i was able to get mysqld back up and running in recovery mode
(basically read-only) and got a mysqldump of all databases. i then
purged all existing mysql data, reinstalled mariadb-server, and restored
the mysqldump. everything came up as expected and we were good to go!</p>
<p>the raid is now in a raid0 config, leaving us with 468gb (not GiB)
available space. thanks for tuning in to this episode of sysadmin
adventures!</p>

    </div>

	<script src="https://utteranc.es/client.js"
        repo="benharri/blog"
        issue-term="title"
        crossorigin="anonymous"
        theme="github-dark"
        async>
	</script>

<footer>
    CC by-nc-nd <a href="https://tilde.team/~ben/">~ben</a> &mdash; <a href="https://tildegit.org/ben/blog">site source</a>
</footer>
</main>
    </body>
</html>
