
<!DOCTYPE html>
<html lang="en-us">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" type="text/css" href="_pagefind/pagefind-ui.css">
        <script type="text/javascript" src="_pagefind/pagefind-ui.js"></script>
        <style>:root {
  --pagefind-ui-scale: 1;
  --pagefind-ui-primary: #034ad8;
  --pagefind-ui-text: #ebdbb2;
  --pagefind-ui-background: #3c3836;
  --pagefind-ui-border: #eeeeee;
  --pagefind-ui-tag: #034ad8;
  --pagefind-ui-border-width: 2px;
  --pagefind-ui-border-radius: 8px;
  ----pagefind-ui-image-border-radius: 8px;
  --pagefind-ui-image-box-ratio: 3 / 2;
  --pagefind-ui-font: inherit; }

main {
  -webkit-font-feature-settings: "liga" on, "calt" on;
  -webkit-font-smoothing: antialiased;
  text-rendering: optimizeLegibility;
  font-family: 'JetBrains Mono', 'Input Mono', monospace;
  max-width: 38rem;
  padding: 2rem;
  margin: auto; }

@media only screen and (max-device-width: 736px) {
  main {
    padding: 0.2rem; } }

::selection {
  background: #9c0018; }

body {
  background: #282828;
  color: #ebdbb2; }

pre {
  background-color: #3c3836;
  padding: 1em;
  border: 0;
  overflow: auto;
  white-space: pre-wrap; }

a, a:active, a:visited {
  color: #e491b6;
  background-color: #1d2021; }

h1, h2, h3, h4, h5 {
  margin-bottom: .1rem; }

blockquote {
  border-left: 1px solid #bdae93;
  margin: 0.5em 10px;
  padding: 0.5em 10px; }

footer {
  align: center; }

img {
  max-width: 100%; }
</style>
        <script>
            window.addEventListener('DOMContentLoaded', (event) => { new PagefindUI({ element: "#search" }); });
        </script>
        <title>networking nonsense</title>
    </head>

    <body>
        <main>
            <div id="search"></div>
    <h1 data-pagefind-meta="title"><a href="./networking-nonsense.html">networking nonsense</a></h1>

    <time>Mon, 11 Feb 2019 02:40 UTC</time>
    <p>tags:</p>
     
<ul data-pagefind-meta="tags">
     <li>
        <a href="tags/tilde.html">tilde</a>
    </li> <li>
        <a href="tags/linux.html">linux</a>
    </li> <li>
        <a href="tags/sysadmin.html">sysadmin</a>
    </li></ul>



    <hr>

    <div data-pagefind-body>
    <p>i&rsquo;ve recently been working on setting up <a href="https://drone.tildegit.org">drone
ci</a> on the tilde.team machine. however,
there&rsquo;s been something strange going on with the networking on there.</p>
<!-- raw HTML omitted -->
<p>starting up drone with
<a href="https://tildegit.org/tildeverse/drone/src/branch/master/docker-compose.yml">docker-compose</a>
didn&rsquo;t seem to be working: <code>netstat -tulpn</code> showed the port binding
properly to 127.0.0.1:8888 but i was completely unable to get anything
from it (using curl the nginx proxy that was to come).</p>
<p>i ended up scrapping docker on the ~team box itself and moving it into a
lxd container (pronounced &ldquo;lex-dee&rdquo;) with nesting enabled.</p>
<p>this got us in to another problem that had been seen before when using
nginx to proxy to apps running in other containers. requests were
dropped intermittently, sometimes hanging for upwards of 30 seconds.</p>
<p>getting frustrated with this error, i tried to reproduce it on another
host. both the docker-proxy and nginx-&gt;lxd proxies work on the first
try yielded no clues as to where things were going wrong.</p>
<p>in a half-awake stupor last saturday evening, i decided to try rule out
ipv6 by disabling it system-wide. as is expected for sleepy work, it
didn&rsquo;t fix the problem and created more in the process.</p>
<p>feeling satisfied that the problem didn&rsquo;t lie with ipv6, i re-enabled
it, only to find that i was unable to bind nginx to my allocated /64. i
may or may not have ranted a bit about this on irc but i was able to get
it back up and running by restarting systemd-networkd.</p>
<p>one step forwards broke something and now we&rsquo;re back to where we started
with the original problem of the intermittent hangups to the lxd
container.</p>
<p>seeing my troubles on irc, <a href="https://tilde.team/~jchelpau/">jchelpau</a>
offered to help dig in to the problem with a a fresh set of eyes. he
noted right away that pings over ipv6 to the containers worked fine, but
ipv4 did not.</p>
<p>we ended up looking at the firewall configurations, only to find that
one of the subnets i blocked after november&rsquo;s <a href="november-13-post-mortem.html">nmap
incident</a> included lxdbr0&rsquo;s subnet (the
bridge device used by lxd).</p>
<p>now that i made the exeption for lxdbr0, everything is working as
expected!</p>
<p>thanks to <a href="https://tilde.team/~fosslinux/">fosslinux</a> and
<a href="https://tilde.team/~jchelpau/">jchelpau</a> for their debugging help!</p>

    </div>

	<script src="https://utteranc.es/client.js"
        repo="benharri/blog"
        issue-term="title"
        crossorigin="anonymous"
        theme="github-dark"
        async>
	</script>

<footer>
    CC by-nc-nd <a href="https://tilde.team/~ben/">~ben</a> &mdash; <a href="https://tildegit.org/ben/blog">site source</a>
</footer>
</main>
    </body>
</html>
